# ğŸ“ Sistema de GestiÃ³n Escolar - Backend API

API REST para el sistema de gestiÃ³n y reporte de calificaciones escolares. Permite a maestros registrar calificaciones y al Ã¡rea de Control Escolar supervisar y generar reportes completos.

[![Node.js](https://img.shields.io/badge/Node.js-18+-green)](https://nodejs.org/)
[![Express](https://img.shields.io/badge/Express-4.18-blue)](https://expressjs.com/)
[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-15-blue)](https://www.postgresql.org/)
[![Sequelize](https://img.shields.io/badge/Sequelize-6.37-orange)](https://sequelize.org/)
[![License](https://img.shields.io/badge/license-MIT-green)](LICENSE)

---

## ğŸ“‹ Tabla de Contenidos

- [CaracterÃ­sticas](#caracterÃ­sticas)
- [Stack TecnolÃ³gico](#stack-tecnolÃ³gico)
- [Requisitos Previos](#requisitos-previos)
- [InstalaciÃ³n](#instalaciÃ³n)
- [ConfiguraciÃ³n](#configuraciÃ³n)
- [Uso](#uso)
- [API Endpoints](#api-endpoints)
- [Docker](#docker)
- [Testing](#testing)
- [Troubleshooting](#troubleshooting)

---

## âœ¨ CaracterÃ­sticas

- âœ… **Arquitectura MVC** bien estructurada
- âœ… **AutenticaciÃ³n JWT** con roles (MAESTRO/CONTROL_ESCOLAR)
- âœ… **Rate Limiting** para prevenir abuso
- âœ… **ValidaciÃ³n robusta** con express-validator
- âœ… **Soft Delete** en calificaciones
- âœ… **Migraciones y Seeders** automatizados
- âœ… **Manejo centralizado de errores**
- âœ… **DocumentaciÃ³n completa** de endpoints
- âœ… **Docker** ready

---

## ğŸš€ Stack TecnolÃ³gico

| TecnologÃ­a | VersiÃ³n | PropÃ³sito |
|------------|---------|-----------|
| Node.js | 18+ | Runtime |
| Express.js | 4.18 | Framework web |
| PostgreSQL | 15 | Base de datos |
| Sequelize | 6.37 | ORM |
| JWT | 9.0 | AutenticaciÃ³n |
| Bcryptjs | 2.4 | EncriptaciÃ³n |
| Helmet | 7.0 | Seguridad HTTP |
| Express Rate Limit | 7.1 | Rate limiting |
| Morgan | 1.10 | Logging |

---

## ğŸ“¦ Requisitos Previos

- **Node.js** >= 18.0.0 ([Descargar](https://nodejs.org/))
- **PostgreSQL** >= 13 ([Descargar](https://www.postgresql.org/download/))
- **npm** >= 9.0.0 (incluido con Node.js)
- **Git** ([Descargar](https://git-scm.com/))

---

## ğŸ”§ InstalaciÃ³n

### 1. Clonar el Repositorio

```bash
git clone https://github.com/tu-usuario/school_management_backend.git
cd school_management_backend
```

### 2. Instalar Dependencias

```bash
npm install
```

### 3. Configurar Variables de Entorno

```bash
cp .env.example .env
```

Edita el archivo `.env` con tus configuraciones:

```env
# Entorno
NODE_ENV=development

# Servidor
PORT=3000
API_PREFIX=/api

# Base de Datos
DB_HOST=localhost
DB_PORT=5432
DB_NAME=school_management
DB_USER=postgres
DB_PASSWORD=tu_password_aqui
DB_DIALECT=postgres

# JWT
JWT_SECRET=tu_secreto_super_seguro_cambialo_en_produccion
JWT_EXPIRES_IN=24h

# CORS
CORS_ORIGIN=http://localhost:5173

# Logging
LOG_LEVEL=info
```

### 4. Crear Base de Datos

```bash
# Conectar a PostgreSQL
psql -U postgres

# Crear base de datos
CREATE DATABASE school_management;

# Salir
\q
```

### 5. Ejecutar Migraciones

```bash
npm run db:migrate
```

**Salida esperada:**
```
== 20240101000001-create-usuarios: migrating =======
== 20240101000001-create-usuarios: migrated (0.045s)
== 20240101000002-create-alumnos: migrating =======
== 20240101000002-create-alumnos: migrated (0.032s)
== 20240101000003-create-materias: migrating =======
== 20240101000003-create-materias: migrated (0.028s)
== 20240101000004-create-calificaciones: migrating =======
== 20240101000004-create-calificaciones: migrated (0.051s)
```

### 6. Ejecutar Seeders (Datos de Prueba)

```bash
npm run db:seed
```

**Datos creados:**
- 1 usuario Control Escolar (admin)
- 3 usuarios Maestros
- 10 Alumnos
- 8 Materias
- 13 Calificaciones de ejemplo

### 7. Iniciar Servidor

```bash
# Desarrollo
npm run dev

# ProducciÃ³n
npm start
```

**Servidor corriendo en:** `http://localhost:3000`

---

## âš™ï¸ ConfiguraciÃ³n

### Variables de Entorno

| Variable | DescripciÃ³n | Ejemplo | Requerida |
|----------|-------------|---------|-----------|
| `NODE_ENV` | Entorno de ejecuciÃ³n | `development` | âŒ |
| `PORT` | Puerto del servidor | `3000` | âŒ |
| `DB_HOST` | Host de PostgreSQL | `localhost` | âœ… |
| `DB_PORT` | Puerto de PostgreSQL | `5432` | âŒ |
| `DB_NAME` | Nombre de la base de datos | `school_management` | âœ… |
| `DB_USER` | Usuario de PostgreSQL | `postgres` | âœ… |
| `DB_PASSWORD` | ContraseÃ±a de PostgreSQL | `password123` | âœ… |
| `JWT_SECRET` | Secreto para JWT | `secret_key` | âœ… |
| `JWT_EXPIRES_IN` | ExpiraciÃ³n del token | `24h` | âŒ |
| `CORS_ORIGIN` | Origen permitido para CORS | `http://localhost:5173` | âŒ |

### Comandos Ãštiles

```bash
# Desarrollo con auto-reload
npm run dev

# ProducciÃ³n
npm start

# Migraciones
npm run db:migrate              # Ejecutar todas las migraciones
npm run db:migrate:undo         # Revertir Ãºltima migraciÃ³n
npm run db:migrate:undo:all     # Revertir todas las migraciones

# Seeders
npm run db:seed                 # Ejecutar todos los seeders
npm run db:seed:undo:all        # Revertir todos los seeders

# Reset completo
npm run db:reset                # Revertir todo, migrar y seed

# Linting
npm run lint                    # Verificar cÃ³digo
npm run lint:fix                # Corregir automÃ¡ticamente

# Formateo
npm run format                  # Formatear cÃ³digo con Prettier

# Testing
npm test                        # Ejecutar tests
```

---

## ğŸ“š API Endpoints

### Base URL
```
http://localhost:3000/api
```

### AutenticaciÃ³n

#### `POST /api/auth/login`
Iniciar sesiÃ³n

**Body:**
```json
{
  "email": "admin@school.com",
  "password": "admin123"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Login exitoso",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "usuario": {
      "id": 1,
      "nombre": "Administrador del Sistema",
      "email": "admin@school.com",
      "rol": "CONTROL_ESCOLAR"
    }
  }
}
```

#### `GET /api/auth/perfil`
Obtener perfil del usuario autenticado

**Headers:**
```
Authorization: Bearer {token}
```

#### `POST /api/auth/refresh`
Refrescar token JWT

---

### Maestro

#### `GET /api/maestro/alumnos`
Obtener alumnos asignados

**Headers:**
```
Authorization: Bearer {token}
```

**Query Params:**
- `grupo` (opcional): Filtrar por grupo

#### `GET /api/maestro/calificaciones`
Obtener calificaciones del maestro

**Query Params:**
- `materia_id` (opcional)
- `alumno_id` (opcional)
- `grupo` (opcional)

#### `POST /api/maestro/calificaciones`
Crear o actualizar calificaciÃ³n

**Body:**
```json
{
  "alumno_id": 1,
  "materia_id": 1,
  "nota": 85.5,
  "observaciones": "Buen desempeÃ±o"
}
```

---

### Control Escolar

#### `GET /api/controlescolar/reporte`
Obtener reportes de promedios

**Query Params:**
- `alumno_id`: Reporte por alumno
- `materia_id`: Reporte por materia
- `grupo`: Reporte por grupo
- Sin parÃ¡metros: Reporte general

#### `DELETE /api/controlescolar/calificaciones/:id`
Eliminar calificaciÃ³n (soft delete)

---

### Otros

#### `GET /health`
Health check del servidor

**Response:**
```json
{
  "status": "OK",
  "timestamp": "2024-12-04T10:30:00.000Z",
  "uptime": 123.45,
  "environment": "development"
}
```

---

## ğŸ³ Docker

### Ejecutar con Docker Compose

```bash
# Levantar servicios
docker-compose up -d

# Ver logs
docker-compose logs -f backend

# Detener servicios
docker-compose down

# Limpiar todo (incluyendo volÃºmenes)
docker-compose down -v
```

### Dockerfile

El proyecto incluye un `Dockerfile` optimizado:

```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
EXPOSE 3000
CMD ["sh", "-c", "npx sequelize-cli db:migrate && npx sequelize-cli db:seed:all && npm start"]
```

---

## ğŸ” Credenciales de Prueba

DespuÃ©s de ejecutar los seeders:

### Control Escolar (Admin)
- **Email:** `admin@school.com`
- **Password:** `admin123`

### Maestros
- **Maestro 1:** `maestro1@school.com` / `maestro123`
- **Maestro 2:** `maestro2@school.com` / `maestro123`
- **Maestro 3:** `maestro3@school.com` / `maestro123`

---

## ğŸ§ª Testing

```bash
# Ejecutar tests
npm test

# Con cobertura
npm run test:coverage
```

---

## ğŸ› Troubleshooting

### Error: "Cannot connect to database"

**Causa:** PostgreSQL no estÃ¡ corriendo o credenciales incorrectas

**SoluciÃ³n:**
```bash
# Verificar que PostgreSQL estÃ© corriendo
# Windows
services.msc
# Linux/Mac
sudo systemctl status postgresql

# Verificar conexiÃ³n
psql -U postgres -d school_management
```

### Error: "Relation does not exist"

**Causa:** Las migraciones no se ejecutaron

**SoluciÃ³n:**
```bash
npm run db:reset
```

### Error: "Port 3000 already in use"

**Causa:** Otro proceso estÃ¡ usando el puerto

**SoluciÃ³n:**
```bash
# Windows
netstat -ano | findstr :3000
taskkill /PID <PID> /F

# Linux/Mac
lsof -ti:3000 | xargs kill -9
```

### Error: "JWT malformed"

**Causa:** Token invÃ¡lido o no proporcionado

**SoluciÃ³n:**
- Verificar que el token estÃ© en el header `Authorization: Bearer {token}`
- Hacer login nuevamente para obtener un token vÃ¡lido

---

## ğŸ“ Estructura del Proyecto

```
src/
â”œâ”€â”€ config/              # Configuraciones
â”‚   â”œâ”€â”€ database.js     # Config de Sequelize
â”‚   â””â”€â”€ jwt.js          # Config de JWT
â”œâ”€â”€ models/             # Modelos de Sequelize
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ Usuario.js
â”‚   â”œâ”€â”€ Alumno.js
â”‚   â”œâ”€â”€ Materia.js
â”‚   â””â”€â”€ Calificacion.js
â”œâ”€â”€ controllers/        # LÃ³gica de negocio
â”‚   â”œâ”€â”€ authController.js
â”‚   â”œâ”€â”€ maestroController.js
â”‚   â””â”€â”€ controlescolarController.js
â”œâ”€â”€ routes/            # DefiniciÃ³n de endpoints
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ authRoutes.js
â”‚   â”œâ”€â”€ maestroRoutes.js
â”‚   â””â”€â”€ controlescolarRoutes.js
â”œâ”€â”€ middlewares/       # Middlewares
â”‚   â”œâ”€â”€ authMiddleware.js
â”‚   â”œâ”€â”€ roleMiddleware.js
â”‚   â”œâ”€â”€ errorHandler.js
â”‚   â”œâ”€â”€ validationMiddleware.js
â”‚   â””â”€â”€ rateLimitMiddleware.js
â””â”€â”€ app.js            # Punto de entrada
```

---

## ğŸ¤ ContribuciÃ³n

1. Fork el proyecto
2. Crea una rama (`git checkout -b feature/AmazingFeature`)
3. Commit tus cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abre un Pull Request

---

## ğŸ“ Licencia

Este proyecto estÃ¡ bajo la Licencia MIT. Ver archivo `LICENSE` para mÃ¡s detalles.

---

## ğŸ”— Enlaces

- [Frontend Repository](https://github.com/tu-usuario/school_management_frontend)
- [DocumentaciÃ³n de API](docs/API.md)
- [Postman Collection](postman/collection.json)

---

## ğŸ‘¥ Autor

Desarrollado como prueba tÃ©cnica para NexGen

---

**Â¿Necesitas ayuda?** Abre un [issue](https://github.com/tu-usuario/school_management_backend/issues) en GitHub.